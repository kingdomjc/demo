<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资金方配置 V2</title>
    <style>
        :root {
            --primary: #2c7be5;
            --secondary: #6e84a3;
            --success: #00d97e;
            --danger: #e63757;
            --border: #e3ebf6;
            --bg: #f9fbfd;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui;
        }
        body {
            background: var(--bg);
            padding: 16px;
            color: #2d3748;
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            padding: 16px;
        }
        .legend {
            margin-bottom: 16px;
            padding: 10px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        .legend ul {
            list-style: none;
        }
        .legend li {
            margin-bottom: 4px;
        }
        .section {
            padding: 20px;
            border-bottom: 3px solid var(--primary);
            margin-bottom: 16px;
        }
        .section:last-child {
            border: none;
            margin-bottom: 0;
        }
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }
        /* 标识样式 */
        label.required::after {
            content: "*";
            color: var(--danger);
            margin-left: 4px;
        }
        label.auto-fixed::after {
            content: "*";
            color: var(--secondary);
            margin-left: 4px;
        }
        label.auto-edit::after {
            content: "*";
            color: var(--success);
            margin-left: 4px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        label {
            font-weight: 500;
            color: #4a5568;
        }
        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(44,123,229,0.1);
            outline: none;
        }
        .radio-group {
            display: flex;
            gap: 24px;
            padding: 8px 0;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-container {
            margin-top: 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th {
            background: #f8fafc;
            padding: 12px;
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        tr:last-child td {
            border: none;
        }
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            border: none;
            background: var(--primary);
            color: white;
        }
        .btn-sm {
            padding: 4px 8px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .switch-container {
            display: flex;
            align-items: center;
            gap: 32px;
            padding: 6px 0;
        }
        .switch-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* 模态框通用样式 */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            overflow: auto;
        }
        #formulaModal .modal-content {
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
        }
        /* 线下结费公式内容样式 */
        #formulaModal .formula-content .search-section { margin: 20px 0; }
        #formulaModal .formula-content .form-item { margin-right: 10px; display: inline-block; }
        #formulaModal .formula-content .form-item input { padding: 8px 12px; border: 1px solid #ddd; }
        #formulaModal .formula-content .btn { padding: 8px 16px; margin-left: 5px; background: #333; color: white; border: none; cursor: pointer; }
        #formulaModal .formula-content .btn-red { background: #f44336; }
        #formulaModal .formula-content table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #formulaModal .formula-content th,
        #formulaModal .formula-content td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        #formulaModal .formula-content .nested-table { width: 100%; margin-top: 5px; }
        /* 应收/应付费用项区域 */
        .fees-container {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .fee-table {
            flex: 1;
            min-width: 280px;
        }
        .fee-table h3 {
            margin-bottom: 8px;
        }
        .fee-table .table-container {
            margin-bottom: 8px;
        }
        .fee-table .add-btn {
            text-align: right;
        }
        /* 关联账号弹窗样式优化 */
        #accountModal .modal-content {
            width: 800px;
            max-width: 90%;
            max-height: 80vh;
        }
        #accountModal .selected-accounts {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        #accountModal .account-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f9fbfd;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        .compensation-header {
            margin-bottom: 16px;
        }
        .balance-display {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .balance-label {
            font-weight: 600;
            color: #FF4D4F;
        }
        .capital-flow {
            color: #4a5568;
            font-weight: 500;
            padding: 6px 0;
        }
        /* 让标识说明（?）按钮对齐到 "基础配置" 右上角 */
        .tooltip {
            position: relative; /* 让它跟随父级 section-header */
            background: var(--primary);
            color: white;
            padding: 6px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin-left: auto; /* 让它自动对齐右侧 */
        }

        /* 让悬浮说明框出现在 ? 按钮的下方 */
        .tooltip-content {
            display: none;
            position: absolute;
            top: 30px; /* 向下偏移 */
            right: 0;
            background: white;
            color: black;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 220px;
            font-size: 14px;
            z-index: 10;
        }

        /* 鼠标悬停显示内容 */
        .tooltip:hover .tooltip-content {
            display: block;
        }
        /* 费率配置整体标识 */
        .section.auto-edit .section-title::after {
            content: "*";
            color: var(--success);
            margin-left: 8px;
        }
        .section.required .section-title::after {
            content: "*";
            color: var(--danger);
            margin-left: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <form id="configForm">
        <!-- 基础配置 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">基础配置</div>
                <!-- 把标识说明按钮放入白色背景内 -->
                <div class="tooltip">?
                    <div class="tooltip-content">
                        <strong>标识说明：</strong>
                        <div><span style="color: var(--danger);">*</span> 必填项</div>
                        <div><span style="color: var(--secondary);">*</span> 系统生成（不可修改）</div>
                        <div><span style="color: var(--success);">*</span> 系统生成（可修改）</div>
                    </div>
                </div>
            </div>
            <div class="form-grid">
                <div class="form-item">
                    <label class="required">资金项目名称</label>
                    <select required>
                        <option value="">请选择项目</option>
                        <option>项目A</option>
                        <option>项目B</option>
                    </select>
                </div>
                <div class="form-item">
                    <label class="required">项目类型</label>
                    <select required>
                        <option>类型1</option>
                        <option>类型2</option>
                    </select>
                </div>
                <div class="form-item">
                    <label class="auto-fixed">支持的订单类型</label>
                    <div class="switch-container">
                        <label class="switch-item">
                            <input type="checkbox" name="irr24" disabled>
                            <span>IRR24</span>
                        </label>
                        <label class="switch-item">
                            <input type="checkbox" name="irr36" disabled>
                            <span>IRR36</span>
                        </label>
                    </div>
                </div>
                <div class="form-item">
                    <label class="auto-fixed">签约规模（亿）</label>
                    <input type="number" step="0.01" disabled>
                </div>
                <div class="form-item">
                    <label class="auto-fixed">放款日期</label>
                    <input type="date" disabled>
                </div>
                <div class="form-item">
                    <label class="auto-fixed">状态</label>
                    <select disabled>
                        <option>新建</option>
                        <option>进行中</option>
                        <option>重新修改</option>
                        <option>结束</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 责任人员 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">责任人员</div>
            </div>
            <div class="form-grid">
                <div class="form-item">
                    <label class="required">资金运营负责人</label>
                    <input type="text" required>
                </div>
                <div class="form-item">
                    <label class="required">开发负责人</label>
                    <input type="text" required>
                </div>
                <div class="form-item">
                    <label>协助人员</label>
                    <input type="text">
                </div>
                <div class="form-item">
                    <label>业务开发负责人</label>
                    <input type="text">
                </div>
                <div class="form-item">
                    <label>业务产品</label>
                    <select>
                        <option>产品A</option>
                        <option>产品B</option>
                    </select>
                </div>
                <div class="form-item">
                    <label>商户经理</label>
                    <select>
                        <option>经理A</option>
                        <option>经理B</option>
                    </select>
                </div>

            </div>
        </div>

        <!-- 文档配置 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">文档配置</div>
            </div>
            <div class="form-grid">
                <div class="form-item">
                    <label>业务产品文档URL</label>
                    <input type="url" placeholder="请输入文档URL">
                </div>
                <div class="form-item">
                    <label>资金运营文档URL</label>
                    <input type="url" placeholder="请输入文档URL">
                </div>
            </div>
        </div>

        <!-- 备注 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">备注</div>
            </div>
            <div class="form-grid">
                <div class="form-item" style="grid-column: 1/-1">
                    <textarea rows="3" placeholder="请输入备注信息"></textarea>
                </div>
            </div>
        </div>

        <!-- 线下月结算（全部非必填） -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">线下月结算</div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="window.location.href='offline_fee_formula.html'">跳转线下结费公式</button>
            </div>
            <div class="form-grid">
                <div class="form-item">
                    <label>是否有月结流水线</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="flow"> 是
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="flow"> 否
                        </label>
                    </div>
                </div>
                <div class="form-item">
                    <label>是否有月结收款结算</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="collection"> 是
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="collection"> 否
                        </label>
                    </div>
                </div>
                <div class="form-item">
                    <label>是否有月结付款结算</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="payment"> 是
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="payment"> 否
                        </label>
                    </div>
                </div>
            </div>
            <!-- 费用项区域依旧保留 -->
            <div class="fees-container" style="margin-top:16px;">
                <!-- 应收费用项 -->
                <div class="fee-table receivable">
                    <h3>应收费用项<span style="color: var(--success);">*</span></h3>
                    <div class="table-container">
                        <table id="receivableTable">
                            <thead>
                            <tr>
                                <th>费用名称</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>技术服务费</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm formula-btn">查看</button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>
                                </td>
                            </tr>
                            <tr>
                                <td>浮动服务费</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm formula-btn">查看</button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="add-btn">
                        <button type="button" class="btn btn-success btn-sm" onclick="addReceivableRow()">+ 新增</button>
                    </div>
                </div>
                <!-- 应付费用项 -->
                <div class="fee-table payable">
                    <h3>应付费用项<span style="color: var(--success);">*</span></h3>
                    <div class="table-container">
                        <table id="payableTable">
                            <thead>
                            <tr>
                                <th>费用名称</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>渠道费</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm formula-btn">查看</button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>
                                </td>
                            </tr>
                            <tr>
                                <td>担保费</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm formula-btn">查看</button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="add-btn">
                        <button type="button" class="btn btn-success btn-sm" onclick="addPayableRow()">+ 新增</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 参与方配置（关键配置标识★） -->

        <div class="section required">
            <div class="section-header">
                <div class="section-title">参与方配置</div>
                <button type="button" class="btn btn-success btn-sm">+ 新增参与方</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>类型<span class="required"></span></th>
                        <th>归属主体<span class="required"></span></th>
                        <th>状态<span class="required"></span></th>
                        <th>生效时间开始<span class="required"></span></th>
                        <th>生效时间结束<span class="required"></span></th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <select required>
                                <option>类型A</option>
                            </select>
                        </td>
                        <td>
                            <select required>
                                <option>主体A</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" value="未初始化" required>
                        </td>
                        <td>
                            <input type="date" value="2025-03-18" required>
                        </td>
                        <td>
                            <input type="date" value="2099-12-31" required>
                        </td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm link-account">关联账号</button>
                            <a href="capital_flow_config.html" class="btn btn-secondary btn-sm">费用资金流</a>
                            <button type="button" class="btn btn-danger btn-sm">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 项目关联的银行卡 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">项目关联的银行卡</div>
                <button type="button" class="btn btn-success btn-sm" onclick="addBankCardRow()">+ 新增</button>
                <!-- 已移除跳转至银行账户管理的链接 -->
            </div>
            <div class="table-container">
                <table id="bankCardTable">
                    <thead>
                    <tr>
                        <th>账户用途</th>
                        <th>账户类型</th>
                        <th>银行账号</th>
                        <th>归属企业</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr data-id="1">
                        <!-- 账户用途改为文本框 -->
                        <td>
                            <input type="text" placeholder="请输入账户用途">
                        </td>
                        <!-- 新增账户类型列 -->
                        <td>
                            <select class="account-type">
                                <option value="">请选择账户类型</option>
                                <option value="自有账户">自有账户</option>
                                <option value="共管账户">共管账户</option>
                                <option value="资方内部账户">资方内部账户</option>
                                <option value="外部账户">外部账户</option>
                            </select>
                        </td>
                        <td>
                            <select class="bank-account" onchange="updateBankAccount(this)">
                                <option value="">请选择银行账号</option>
                                <option value="6222020000000001" data-enterprise="企业A">工商银行-北京分行-6222020000000001</option>
                                <option value="6222020000000002" data-enterprise="企业B">工商银行-北京分行-6222020000000002</option>
                            </select>
                        </td>
                        <td class="enterprise">
                            <span></span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteBankCardRow(this)">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 新增弹窗：关联银行账号 -->
        <div class="modal-mask" id="accountModal">
            <div class="modal-content">
                <h3 style="margin-bottom:16px">关联银行账号</h3>
                <select class="account-select" style="width:100%">
                    <option value="">请选择银行账号</option>
                    <option value="6222020000000001" data-enterprise="企业A">工商银行-北京分行-6222020000000001</option>
                    <option value="6222020000000002" data-enterprise="企业B">工商银行-北京分行-6222020000000002</option>
                    <option value="6222020000000003" data-enterprise="企业C">工商银行-北京分行-6222020000000003</option>
                </select>
                <div class="selected-accounts" id="selectedAccounts"></div>
                <div style="margin-top:16px;text-align:right">
                    <button type="button" class="btn btn-primary" onclick="closeAccountModal()">完成</button>
                </div>
            </div>
        </div>

        <!-- 费用资金流弹窗 -->
        <div class="modal-mask" id="feeFlowModal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
            <div class="modal-content" style="background:#fff; padding:20px; border-radius:8px; position: relative; max-width:90%; max-height:90%; overflow:auto;">
                <button type="button" class="btn btn-danger" style="position: absolute; right: 10px; top: 10px;" onclick="closeFeeFlowModal()">关闭</button>
                <h2 style="text-align:center;">费用资金流</h2>
                <div style="text-align:center; margin-top:20px;">
                    <img src="image.svg" alt="费用资金流" style="max-width:100%; height:auto;">
                </div>
            </div>
        </div>

        <!-- 资金流配置模块（放在费率配置之前） -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">资金流配置</div>
            </div>
            <!-- 新增列按钮放在表格下方 -->
            <div style="margin-top:8px;">
                <button type="button" class="btn btn-success btn-sm" onclick="addNewColumn()">新增列</button>
            </div>
            <!-- 表格容器增加 overflow-x: auto -->
            <div class="table-container" style="overflow-x:auto;">
                <table id="capitalFlowTable" class="capital-flow-table" border="1" cellspacing="0" cellpadding="6">
                    <thead>
                    <tr>
                        <!-- 固定列：场景，右侧带新增整组按钮 -->
                        <th>
                            场景
                            <button type="button" class="btn btn-success btn-sm" onclick="addSceneGroup()">＋</button>
                        </th>
                        <!-- 固定列：细分场景 -->
                        <th>细分场景</th>
                        <!-- 动态列：费用项 -->
                        <th>
                            <input type="text" value="本金" style="border:none; background:transparent; text-align:center;">
                            <button type="button" class="small-btn" onclick="deleteColumnAt(this)">x</button>
                        </th>
                        <th>
                            <input type="text" value="利息" style="border:none; background:transparent; text-align:center;">
                            <button type="button" class="small-btn" onclick="deleteColumnAt(this)">x</button>
                        </th>
                        <th>
                            <input type="text" value="罚息" style="border:none; background:transparent; text-align:center;">
                            <button type="button" class="small-btn" onclick="deleteColumnAt(this)">x</button>
                        </th>
                        <!-- 操作列 -->
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 初始场景组（组头），其中场景单元格右侧带新增子行按钮 -->
                    <tr class="scene-group">
                        <td class="scene-cell" rowspan="1">
                            <input type="text" value="请输入场景">
                            <button type="button" class="btn btn-success btn-sm" onclick="addSubRow(this)">＋</button>
                        </td>
                        <td><input type="text" placeholder="请输入细分场景"></td>
                        <td><input type="text" placeholder="请输入资金流"></td>
                        <td><input type="text" placeholder="请输入资金流"></td>
                        <td><input type="text" placeholder="请输入资金流"></td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow2(this)">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- 费率配置（系统自动生成，用户可修改） -->
        <div class="section auto-edit">
            <div class="section-header">
                <div class="section-title">费率配置</div>
                <button type="button" class="btn btn-success btn-sm" onclick="addFeeRateRow()">+ 添加</button>
            </div>
            <div class="table-container">
                <table id="feeRateTable">
                    <thead>
                    <tr>
                        <th>费用项</th>
                        <th>产品类型</th>
                        <th>产品期数</th>
                        <th>生效时间</th>
                        <th>费率</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <select>
                                <option value="本金">本金</option>
                                <option value="利息" selected>利息</option>
                                <option value="罚息">罚息</option>
                                <option value="资方担保费">资方担保费</option>
                                <option value="担保费">担保费</option>
                                <option value="服务费">服务费</option>
                                <option value="债务管理费">债务管理费</option>
                            </select>
                        </td>
                        <td>
                            <select>
                                <option value="irr24" selected>irr24</option>
                                <option value="irr36">irr36</option>
                            </select>
                        </td>
                        <td>
                            <select>
                                <option value="6" selected>6</option>
                                <option value="12">12</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" value="/" placeholder="例：2022-01-02～2025-12-31">
                        </td>
                        <td>
                            <input type="text" value="irr6%" placeholder="请输入费率">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteFeeRateRow(this)">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 代偿&回购配置（整体为系统自动生成，不可修改，在标题上加蓝色标记） -->
        <div class="section">
            <div class="section-header">
                <div class="section-title auto-fixed">代偿&回购配置 <span style="color: var(--secondary); margin-left:8px;">*</span></div>
            </div>
            <div class="compensation-header">
                <div class="capital-flow">
                    资金流路径: 三农信（代偿回购方）->临商银行（资金方）
                </div>
            </div>
            <div class="form-grid">
                <!-- 代偿规则 -->
                <div class="form-item" style="grid-column: span 2;">
                    <label class="auto-fixed">代偿规则及触发时间</label>
                    <div class="input-group">
                        <select name="compensationRule" required disabled>
                            <option value="">请选择</option>
                            <option value="d3_plus2h">D+3天+2时</option>
                            <option value="d3_holiday">D+3天（节假提前）</option>
                            <option value="none">无需代偿</option>
                        </select>
                        <span>触发开始时间</span>
                        <input type="datetime-local" placeholder="开始" required disabled>
                        <span>触发结束时间</span>
                        <input type="datetime-local" placeholder="结束" required disabled>
                    </div>
                </div>
                <!-- 回购规则 -->
                <div class="form-item" style="grid-column: span 2;">
                    <label class="auto-fixed">回购规则及触发时间</label>
                    <div class="input-group">
                        <select name="repurchaseRule" required disabled>
                            <option value="">请选择</option>
                            <option value="3_6">连3累6</option>
                            <option value="3_consecutive">连3期代偿</option>
                            <option value="6_accumulated">累6期代偿</option>
                            <option value="60d">逾期60天</option>
                            <option value="60d_holiday">逾期60天（节假提前）</option>
                            <option value="none">无需回购</option>
                        </select>
                        <span>触发开始时间</span>
                        <input type="datetime-local" placeholder="开始" required disabled>
                        <span>触发结束时间</span>
                        <input type="datetime-local" placeholder="结束" required disabled>
                    </div>
                </div>
            </div>
        </div>

        <!-- 授信规模 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">授信规模</div>
                <button type="button" class="btn btn-success btn-sm">+ 新增授信</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>金额</th>
                        <th>授信状态</th>
                        <th>状态</th>
                        <th>打款时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input type="text"></td>
                        <td>
                            <select>
                                <option>状态A</option>
                            </select>
                        </td>
                        <td>未初始化</td>
                        <td><input type="text" placeholder="HH : mm : ss"></td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 保证金配置 -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">保证金配置</div>
                <button type="button" class="btn btn-success btn-sm">+ 新增配置</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>生效时间开始</th>
                        <th>生效时间结束</th>
                        <th>金额（万）</th>
                        <th>保证金比例</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input type="text"></td>
                        <td><input type="text"></td>
                        <td><input type="text"></td>
                        <td><input type="text" placeholder="%"></td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 预充值配置（关键配置标识★） -->
        <div class="section required">
            <div class="section-header">
                <div class="section-title">预充值配置</div>
                <button type="button" class="btn btn-success btn-sm">+ 新增配置</button>
                <a href="precharge_projects.html" class="btn btn-secondary btn-sm">跳转至预充值项目聚合</a>
            </div>
            <div class="compensation-header">
                <div class="balance-display">
                    <span class="balance-label">代偿户-预充户余额: 10000.00 元</span>
                    <a href="precharge_balance.html" class="btn btn-sm btn-primary">查看预充户余额详情</a>
                </div>
                <div class="balance-display">
                    <span class="balance-label">代收户-预充户余额: 10000.00 元</span>
                    <a href="precharge_balance.html" class="btn btn-sm btn-primary">查看预充户余额详情</a>
                </div>
                <div class="balance-display">
                    <span class="balance-label">保证金-预充户余额: 10000.00 元</span>
                    <a href="precharge_balance.html" class="btn btn-sm btn-primary">查看预充户余额详情</a>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>用途<span class="required"></span></th>
                        <th>核算内容<span class="required"></span></th>
                        <th>费用类型<span class="required"></span></th>
                        <th>预充户公司<span class="required"></span></th>
                        <th>预充户银行账号<span class="required"></span></th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <select required>
                                <option>用途A</option>
                            </select>
                        </td>
                        <td>
                            <select required>
                                <option>核算A</option>
                            </select>
                        </td>
                        <td>
                            <select required>
                                <option>类型A</option>
                            </select>
                        </td>
                        <td>
                            <select required>
                                <option>公司A</option>
                            </select>
                        </td>
                        <td>
                            <select required>
                                <option>账号A</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm">删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 表单操作 -->
        <div class="section">
            <div style="display: flex; gap: 12px; justify-content: flex-end">
                <button type="reset" class="btn">取消</button>
                <button type="submit" class="btn btn-primary">提交配置</button>
            </div>
        </div>
    </form>
</div>

<!-- 线下结费公式模态框 -->
<div class="modal-mask" id="formulaModal">
    <div class="modal-content">
        <button type="button" class="btn btn-danger" style="position: absolute; right: 10px; top: 10px;" onclick="closeFormulaModal()">关闭</button>
        <div class="formula-content">
            <div class="search-section">
                <div class="form-item">
                    <label>资金方项目</label><br>
                    <input type="text" placeholder="请选择">
                </div>
                <div class="form-item">
                    <label>费用名目</label><br>
                    <input type="text" placeholder="请选择">
                </div>
                <button class="btn">重置</button>
                <button class="btn">查询</button>
                <button class="btn">新建</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th></th>
                    <th>资金方项目</th>
                    <th>公式类型</th>
                    <th>费用名目</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td><input type="checkbox"></td>
                    <td>xx银行</td>
                    <td>其他规则</td>
                    <td>技术服务费</td>
                    <td>启用</td>
                    <td>
                        <button class="btn">创建计算公式</button>
                        <button class="btn btn-red">编辑</button>
                        <button class="btn btn-red">删除</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">
                        <table class="nested-table">
                            <thead>
                            <tr>
                                <th>公式</th>
                                <th>产品类型</th>
                                <th>产品期数</th>
                                <th>订单利率</th>
                                <th>订单打款时间范围</th>
                                <th>当月放款量范围</th>
                                <th>在贷日期范围</th>
                                <th>自定义规则</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>每日在贷余额*0.3%/365</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>2023年之前</td>
                                <td>
                                    <button class="btn btn-red">编辑</button>
                                    <button class="btn btn-red">删除</button>
                                </td>
                            </tr>
                            <tr>
                                <td>每日在贷余额*0.5%/365</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>/</td>
                                <td>2023年之后</td>
                                <td>
                                    <button class="btn btn-red">编辑</button>
                                    <button class="btn btn-red">删除</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 以下事件及动态行为代码保持原样
    document.addEventListener('click', function(e) {
        if(e.target && e.target.classList.contains('formula-btn')){
            document.getElementById('formulaModal').style.display = 'flex';
        }
    });

    function addReceivableRow() {
        var tbody = document.getElementById('receivableTable').tBodies[0];
        var row = tbody.insertRow(-1);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        cell1.innerHTML = '<select style="width:100%;"><option value="">请选择费用项</option><option value="技术服务费">技术服务费</option><option value="浮动服务费">浮动服务费</option></select>';
        cell2.innerHTML = '<button type="button" class="btn btn-primary btn-sm formula-btn">查看</button> <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>';
    }

    function addPayableRow() {
        var tbody = document.getElementById('payableTable').tBodies[0];
        var row = tbody.insertRow(-1);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        cell1.innerHTML = '<select style="width:100%;"><option value="">请选择费用项</option><option value="渠道费">渠道费</option><option value="担保费">担保费</option></select>';
        cell2.innerHTML = '<button type="button" class="btn btn-primary btn-sm formula-btn">查看</button> <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>';
    }

    function deleteRow(btn) {
        btn.closest('tr').remove();
    }

    document.querySelectorAll('.link-account').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('accountModal').style.display = 'flex';
        });
    });

    const accountSelect = document.querySelector('.account-select');
    const selectedContainer = document.getElementById('selectedAccounts');

    accountSelect.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const accountText = selectedOption.text;
            const enterprise = selectedOption.getAttribute('data-enterprise') || '';
            const item = document.createElement('div');
            item.className = 'account-item';
            item.innerHTML = `
              <span data-value="${this.value}" data-enterprise="${enterprise}">${accountText}</span>
              <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">删除</button>
            `;
            selectedContainer.appendChild(item);
            this.value = '';
        }
    });

    function closeAccountModal() {
        const modal = document.getElementById('accountModal');
        modal.style.display = 'none';
        const accountItems = selectedContainer.querySelectorAll('.account-item span');
        accountItems.forEach(item => {
            const accountText = item.textContent.trim();
            const enterprise = item.getAttribute('data-enterprise') || '';
            const tbody = document.getElementById('bankCardTable').tBodies[0];
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
              <td>
                  <select class="account-usage">
                      <option value="">请选择账户用途</option>
                      <option value="代偿款账户">代偿款账户</option>
                      <option value="保证金账户">保证金账户</option>
                      <option value="线下还款账户">线下还款账户</option>
                  </select>
              </td>
              <td>${accountText}</td>
              <td class="enterprise">
                  <span>${enterprise}</span>
              </td>
              <td>
                  <button type="button" class="btn btn-danger btn-sm" onclick="deleteBankCardRow(this)">删除</button>
              </td>
            `;
        });
        selectedContainer.innerHTML = '';
    }

    document.getElementById('accountModal').addEventListener('click', e => {
        if(e.target.classList.contains('modal-mask')) closeAccountModal();
    });

    function closeFormulaModal() {
        document.getElementById('formulaModal').style.display = 'none';
    }

    document.getElementById('formulaModal').addEventListener('click', e => {
        if(e.target.classList.contains('modal-mask')) closeFormulaModal();
    });

    document.querySelectorAll('.btn-success').forEach(btn => {
        if (btn.getAttribute('onclick')) return;
        btn.addEventListener('click', () => {
            const table = btn.closest('.section').querySelector('tbody');
            const newRow = table.insertRow(-1);
            newRow.innerHTML = table.rows[0].innerHTML;
        });
    });

    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-danger') && !e.target.closest('table').id.match(/receivableTable|payableTable/)) {
            e.target.closest('tr').remove();
        }
    });

    function addBankCardRow() {
        const tbody = document.getElementById('bankCardTable').tBodies[0];
        const newRow = tbody.insertRow(-1);
        newRow.innerHTML = `
      <td>
          <input type="text" placeholder="请输入账户用途">
      </td>
      <td>
          <select class="account-type">
              <option value="">请选择账户类型</option>
              <option value="自有账户">自有账户</option>
              <option value="共管账户">共管账户</option>
              <option value="资方内部账户">资方内部账户</option>
              <option value="外部账户">外部账户</option>
          </select>
      </td>
      <td>
          <select class="bank-account" onchange="updateBankAccount(this)">
              <option value="">请选择银行账号</option>
              <option value="6222020000000001" data-enterprise="企业A">工商银行-北京分行-6222020000000001</option>
              <option value="6222020000000002" data-enterprise="企业B">工商银行-北京分行-6222020000000002</option>
          </select>
      </td>
      <td class="enterprise">
          <span></span>
      </td>
      <td>
          <button type="button" class="btn btn-danger btn-sm" onclick="deleteBankCardRow(this)">删除</button>
      </td>
    `;
    }

    function updateBankAccount(select) {
        const row = select.closest('tr');
        const accountSelect = row.querySelector('.bank-account');
        if (!accountSelect || !accountSelect.value) return;
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const enterprise = selectedOption.getAttribute('data-enterprise') || '';
        const enterpriseSpan = row.querySelector('.enterprise span');
        if (enterpriseSpan) {
            enterpriseSpan.textContent = enterprise;
        }
        const usageSelect = row.querySelector('.account-usage');
        if (usageSelect && usageSelect.value) {
            usageSelect.parentElement.textContent = usageSelect.options[usageSelect.selectedIndex].text;
            accountSelect.parentElement.textContent = selectedOption.text;
        }
    }

    function deleteBankCardRow(btn) {
        btn.closest('tr').remove();
    }

    function addFeeRateRow() {
        const tbody = document.getElementById('feeRateTable').tBodies[0];
        const newRow = tbody.insertRow(-1);
        newRow.innerHTML = `
          <td>
            <select>
              <option value="本金">本金</option>
              <option value="利息">利息</option>
              <option value="罚息">罚息</option>
              <option value="资方担保费">资方担保费</option>
              <option value="担保费">担保费</option>
              <option value="服务费">服务费</option>
              <option value="债务管理费">债务管理费</option>
            </select>
          </td>
          <td>
            <select>
              <option value="irr24">irr24</option>
              <option value="irr36">irr36</option>
            </select>
          </td>
          <td>
            <select>
              <option value="6">6</option>
              <option value="12">12</option>
            </select>
          </td>
          <td>
            <input type="text" placeholder="例：2022-01-02～2025-12-31">
          </td>
          <td>
            <input type="text" placeholder="请输入费率">
          </td>
          <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteFeeRateRow(this)">删除</button>
          </td>
      `;
    }

    function deleteFeeRateRow(btn) {
        btn.closest('tr').remove();
    }

    function openFeeFlowModal() {
        document.getElementById('feeFlowModal').style.display = 'flex';
    }

    function closeFeeFlowModal() {
        document.getElementById('feeFlowModal').style.display = 'none';
    }

    document.getElementById('feeFlowModal').addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-mask')) {
            closeFeeFlowModal();
        }
    });
    // 新增列：在操作列前插入一列（固定列不受影响）
    function addNewColumn() {
        let table = document.getElementById("capitalFlowTable");
        let headerRow = table.tHead.rows[0];
        let opColIndex = headerRow.cells.length - 1; // 操作列为最后一列
        // 新建 header 单元格，内含 input 和一个小 x 按钮
        let newTh = document.createElement("th");
        newTh.innerHTML = '<input type="text" placeholder="请输入标题" style="border:none; background:transparent; text-align:center;">' +
            '<button type="button" class="small-btn" onclick="deleteColumnAt(this)">x</button>';
        headerRow.insertBefore(newTh, headerRow.cells[opColIndex]);

        // 为 tbody 中每一行插入新单元格，在操作列前面
        let tbody = table.tBodies[0];
        for (let row of tbody.rows) {
            // 注意：对于组头行（包含场景 cell），新单元格应插入在操作列前；
            let cellCount = row.cells.length;
            let newTd = document.createElement("td");
            newTd.innerHTML = '<input type="text" placeholder="请输入">';
            row.insertBefore(newTd, row.cells[cellCount - 1]);
        }
    }

    // 删除列：删除当前 th 及所有 tbody 中对应的单元格
    function deleteColumnAt(btn) {
        let th = btn.parentElement;
        let headerRow = th.parentElement;
        let colIndex = Array.from(headerRow.children).indexOf(th);
        // 不允许删除固定列（索引 0 和 1）
        if (colIndex < 2) {
            alert("固定列不可删除！");
            return;
        }
        headerRow.removeChild(th);
        let tbody = document.getElementById("capitalFlowTable").tBodies[0];
        for (let row of tbody.rows) {
            if (row.cells[colIndex]) {
                row.deleteCell(colIndex);
            }
        }
    }

    // 新增整组场景（组头）：在 tbody 最后添加一行完整的组头行
    function addSceneGroup() {
        let tbody = document.getElementById("capitalFlowTable").tBodies[0];
        let headerRow = document.getElementById("capitalFlowTable").tHead.rows[0];
        let colCount = headerRow.cells.length;
        let newRow = document.createElement("tr");
        newRow.className = "scene-group";
        // 第一列：场景 cell（带新增子行按钮）
        let tdScene = document.createElement("td");
        tdScene.className = "scene-cell";
        tdScene.setAttribute("rowspan", "1");
        tdScene.innerHTML = '<input type="text" value="请输入场景">' +
            '<button type="button" class="btn btn-success btn-sm" onclick="addSubRow(this)">＋</button>';
        newRow.appendChild(tdScene);
        // 其他列：从细分场景到动态列，根据 header 结构（操作列除外）
        for (let i = 1; i < colCount - 1; i++) {
            let td = document.createElement("td");
            // 对于第二列（细分场景）给提示，其余列默认空
            if (i === 1) {
                td.innerHTML = '<input type="text" placeholder="请输入细分场景">';
            } else {
                td.innerHTML = '<input type="text" placeholder="请输入">';
            }
            newRow.appendChild(td);
        }
        // 操作列：删除整组按钮
        let tdOp = document.createElement("td");
        tdOp.innerHTML = '<button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>';
        newRow.appendChild(tdOp);
        tbody.appendChild(newRow);
    }

    // 在当前场景组内新增子行（不显示场景单元格），更新组头 rowspan
    function addSubRow(btn) {
        let currentRow = btn.closest("tr");
        let tbody = currentRow.parentNode;
        // 找到当前组的组头（包含 .scene-cell 的那一行）
        let groupHead = currentRow;
        while (groupHead.previousElementSibling && !groupHead.querySelector('.scene-cell')) {
            groupHead = groupHead.previousElementSibling;
        }
        let sceneCell = groupHead.querySelector('.scene-cell');
        let currentRowspan = parseInt(sceneCell.getAttribute("rowspan")) || 1;
        sceneCell.setAttribute("rowspan", currentRowspan + 1);
        let headerRow = document.getElementById("capitalFlowTable").tHead.rows[0];
        let colCount = headerRow.cells.length;
        let newRow = document.createElement("tr");
        // 子行从“细分场景”（索引1）开始添加单元格，直至操作列（不包含场景 cell）
        for (let i = 1; i < colCount - 1; i++) {
            let td = document.createElement("td");
            if (i === 1) {
                td.innerHTML = '<input type="text" placeholder="请输入细分场景">';
            } else {
                td.innerHTML = '<input type="text" placeholder="请输入">';
            }
            newRow.appendChild(td);
        }
        // 操作列
        let tdOp = document.createElement("td");
        tdOp.innerHTML = '<button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">删除</button>';
        newRow.appendChild(tdOp);
        // 插入到当前组的最后
        let lastGroupRow = groupHead;
        let nextRow = groupHead.nextElementSibling;
        while (nextRow && !nextRow.querySelector('.scene-cell')) {
            lastGroupRow = nextRow;
            nextRow = nextRow.nextElementSibling;
        }
        tbody.insertBefore(newRow, lastGroupRow.nextSibling);
    }

    // 删除行：如果为组头，则删除整个组；如果为子行，则更新组头的 rowspan
    function deleteRow2(btn) {
        let row = btn.closest("tr");
        let tbody = row.parentNode;
        if (row.querySelector('.scene-cell')) {
            // 删除整个组（组头及所有连续子行）
            let groupHead = row;
            let nextRow = groupHead.nextElementSibling;
            while (nextRow && !nextRow.querySelector('.scene-cell')) {
                let temp = nextRow.nextElementSibling;
                nextRow.remove();
                nextRow = temp;
            }
            groupHead.remove();
        } else {
            // 子行：更新组头 rowspan后删除该行
            let prevRow = row.previousElementSibling;
            while (prevRow && !prevRow.querySelector('.scene-cell')) {
                prevRow = prevRow.previousElementSibling;
            }
            if (prevRow && prevRow.querySelector('.scene-cell')) {
                let sceneCell = prevRow.querySelector('.scene-cell');
                let currentRowspan = parseInt(sceneCell.getAttribute("rowspan")) || 1;
                sceneCell.setAttribute("rowspan", currentRowspan - 1);
            }
            row.remove();
        }
    }
</script>
</body>
</html>
